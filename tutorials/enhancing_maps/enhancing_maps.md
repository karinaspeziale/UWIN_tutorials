# UWIN Tutorial: Enhancing maps with OpenStreetMap Data
*Created by Kim Rivera and Tiziana Gelmi-Candusso - last updated December 2024*

This tutorial is aimed at those interested in (1) advancing their spatial mapping skills and (2) integrating OpenStreetMap and other data sources to enhance exisiting spatial datasets. 
This tutorial builds on work described in the manuscript, 
['Leveraging Open-Source Geographic Databases to Enhance the Representation of Landscape Heterogeneity in Ecological Models' (2024)](https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.70402) by Gelmi-Candusso T., Rodriguez P., Fidino, M., Rivera, K., Lehrer, E.W., Magle, S., & Fortin M. 

### Some helpful references:
1. [Manuscript GitHub Repository](https://github.com/tgelmi-candusso/OSM_for_Ecology.git) - Tiziana Gelmi-Candusso 
2. [OpenStreetMap](https://www.openstreetmap.org/export#map=15/-41.15840/-71.31170)
3. [Open Buildings](https://sites.research.google/gr/open-buildings/)
4. [Introduction to spatial mapping](https://github.com/urbanwildlifeinstitute/UWIN_tutorials/blob/main/tutorials/week6_spatial_mapping/spatial-mapping.md) - Tiziana Gelmi Candusso and Mark Jordan 

### Tutorial Aims:

#### <a href="#OpenStreetMaps"> 1. What is OpenStreetMap and why should we use these data?</a>

#### <a href="#pullingandformatting"> 2. Pulling and filtering data</a>

#### <a href="#building"> 3. Building landcover classes</a>

#### <a href="#integrating"> 4. Intgrating Maps</a>


<a name="OpenStreetMaps"></a>

## 1. What is OpenStreetMap and why should we use these data?
Wildlife ecology and behavior are strongly driven by landscape characteristics, especially in urban regions. Cities are among the world's most heterogeneous landscapes however, global land cover maps often represent urban areas as a single, homogeneous class therefore limiting our ability to build useful spatial ecological models over large scales. However, we can use community-based geographic databases, such as OpenStreetMap (OSM), to improve the quality and spatial resolution of urban land cover data. OSM is an open-source mapping platform storing landscape information in the form of geographic polygon features identified by a series of attributes. 

Take the below example of Chicago, Illinois (USA). On the left we see a relativley homogenous ladnscape of 'urban' land cover (in red) from the Commission for Environmental Cooperation Land Use Land Cover data. On the right we have the same dataset overlaid by spatial data collected from OSM. We can see OSM greatly improves our ability to asses heterogeneity in the urban landscape and therefore improve our understanding of urban wildlife ecology. 

<p float="center">
  <img src="./figures/visual_comparison.png" alt="Visual comparison of the global land cover used in this study (Commission for Environmental Cooperation (CEC) LULC map, 30 m resolution, left), and the final output of our workflow, the OSM-enhanced land cover map (30 m resolution, right) at the same location, in Chicago, Illinois, USA. Vegetation areas are represented in green shades, barren soil in brown, built environment or land use areas are represented in red shades, different road types are represented in yellow shades, and building footprints are represented in black." width="1000" height="auto" />

</p>

OSM data generated by community members are supplemented with information from governmental and non-governmental agencies around the globe and these data have been reliably used in diverse ecological research studies. Extracting a few features from the OSM database for small areas can be done directly online, however, extracting larger study areas, or extracting the full database is much more difficult. Therefore, we outline the framework to inetgrate OSM data as described in [Gelmi-Candusso et al., 2024](https://github.com/tgelmi-candusso/OSM_for_Ecology.git). 

<a name="OpenStreetMaps"></a>
## 2. Pulling and filtering data
We will be working through an example custom study area in northern Patagonia, Argentina. Collaborating UWIN partners here are based in the Centro Científico Tecnológico
Consejo Nacional de Investigaciones Científicas y Técnicas (CONICET) in San Carlos de Bariloche in the province of Río Negro, Argentina. 

### Libraries
There are a handful of libraries we will want to install and load into our console, including `osmextract` which was specifically created to easily extract data from OpenStreetMaps. We will also be loaded in some custom functions which we will break down later in this tutorial. 

```R
# Load in libraries
library(osmextract)
library(tidyterra)
library(dplyr)
library(terra)
library(sf)
library(readr)
library(devtools)
library(ggplot2)
library(googledrive)
library(colourpicker)
library(tmap)
library(smoothr)
library(geos)

# Load in functions
source("OSM_to_LULC_functions_Bariloche.R") 
```
### OSM data
OSM data is made up of various features which include linear (e.g. a river or road) and polygon data (e.g. a building or lake). Additionally, features can be assigned **keys** and keys are assigned **values**. **Keys** are generally related to the classification of a landscape feature while **values** are further descriptors of a key. For example, there may be a feature called 'building', with the keys *building* and *parking*. Note a feature may have multiple keys. Then, each of these keys will also have an assigned value. The values may be described as a *school* or a simple *yes* (as in yes this is a building). See examples below.

| feature  | key | value | 
|---------|------|-------|
|Institutional|amenity|school|
|Building|building    |school, hospital, commerical|
|          |parking    |multi-storey| 
|Water          | natural    |spring| 
|          | landuse    |basin| 

We will load in common feature keys and values which have been organized and described in Gelmi-Candusso et al., 2024.  
```R
#table with the key-value pairs to be extracted 
osm_kv <- read_csv(
  "https://raw.githubusercontent.com/tgelmi-candusso/OSM_for_Ecology/main/urban_features/osm_key_values.csv"
) 
osm_kv <- osm_kv %>% 
  filter(!is.na(key))
keys <- unique(osm_kv$key)
```
Now, we will use `osmextract::oe_get` to extract OSM data limited to our keys and study area. We will want to limit our query to the smallest geofrabrik (OSM) data which includes our study area. Our first query pass may be the city level, state level or country level. To find your region (not all cities are able to be queried), it's helpful to is start by querying at the smallest level, e.g. city and see if it matches. If that query is unsuccessful, move on to state and if not available, then to the country. It is also possible to set a boundary, by clipping an extent, around your first query pass.

Let start by setting a larger query location for Argentina and subset to a smaller bounding box based on our unique study region. To find the best query for your data, you can try searching on: https://www.openstreetmap.org/

```R
# Set our first query
place <- "Argentina" 

# Narrow down our first query to a bounding box using latitude/longitude coordinates which wil help load data faster
study_area_bbox <- sf::st_bbox(c(xmin=-71.900000,ymin=-41.262600,xmax=-70.650000,ymax=-40.490000), 
                         crs = "epsg:4326") %>% 
  st_as_sfc() 

# Confirm the box is the correct coordinates for you study area 
plot(study_area_bbox, axes = TRUE)
```
<p float="center">
  <img src="./figures/study_area_bbox.png" alt="A simple plot to confirm the correct coordinates for study region" width="500" height="auto" />

</p>

It helpful to check your grabbing the expected study area as a common mistake is mix up X and Y coordinates! Now we are ready to pull OSM data

```R
pol_feat <- osmextract::oe_get(place = "Argentina", # place we defined above
                               boundary = study_area_bbox, # more specific study area boundary (this helps speed up processing)
                               boundary_type = c("spat","clipsrc"),
                               provider ="geofabrik",
                               layer = "multipolygons",
                               stringsAsFactors = FALSE,
                               quiet = FALSE,
                               force_download = TRUE,
                               extra_tags=keys)
```
Great, we now have all the OSM data defined in our *keys* from our outlined study area. Depending on your research questions or data available for your region, you may wish to limit OSM data to more specific areas within your region, such as local municipalities or urban landscapes. For our example, we will be overlaying OSM data ontop of a global dataset from [Climate Data Store (CDS)](https://cds.climate.copernicus.eu/datasets/satellite-land-cover?tab=download). These data describe land cover into 22 classes which have been defined using the United Nations Food and Agriculture Organization’s (UN FAO) Land Cover Classification System (LCCS) and do a good job describing the natural landscape within our study region. Although OSM data is very powerful in more populated regions, it may do a poorer job describing natural landscapes around urban areas. Therefore, we want to limit our OSM extraction to the urban regions only and use CDS data to describe the surrounding natural landscape. 

We can do this by cherry picking OSM polygons or boundaries and filter our `pol_feat`  on boundaries, osm_id or admin_level. For our purposes, we will isolate two cities, Villa La Angostura and San Carlos de Bariloche and join them in the same multi-polygon layer.

```R
# This filtering grabs the townships of our study area and any landcover class in our study area tagged as 'scrub'. We do this because Bariloche's boundary is outside
# the barriers we want to grab OSM data. Grabbing the smaller municipalities lets us limit our boundary to the city area more specifically. Then we will use 
# a national landcover map to fill in regions not covered well by OSM (e.g. non-urban areas)
study_area_boundary <- pol_feat %>% 
  filter((boundary == "administrative" & admin_level %in% c(8,9) # admin_level=* key describes the administrative level of a feature within a subdivision hierarchy
          & osm_id != 3405247) | natural == "scrub")

# Now we grab the larger Bariloche boundary so we can subset our study area just to Bariloche
bariloche_boundary <- pol_feat %>% 
  filter(osm_id == 3405247)

# Here we subset to our Bariloche boundary (excluding Villa La Angostura). This is so 
# we can apply a smoothing function in our next step. Ignore Warning message here.
sf_use_s2(FALSE)
bariloche <- study_area_boundary %>% 
  st_intersection(bariloche_boundary)
```
Though we have a fairly good buffer around the urban region of Bariloche, we can tidy the boundary up further using a smoothing function. We can play with varibles in this function to buffer more widely or smooth other gaps in the boundary. See the boundary before and after smoothing below.


